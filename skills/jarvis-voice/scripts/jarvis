#!/bin/bash
# Jarvis TTS - metallic robotic voice using sherpa-onnx + ffmpeg
# Usage: jarvis "Hello, this is a test"

export LD_LIBRARY_PATH=/home/globalcaos/.openclaw/tools/sherpa-onnx-tts/lib:$LD_LIBRARY_PATH

RAW_WAV="/tmp/jarvis_raw.wav"
METAL_WAV="/tmp/jarvis_metal.wav"

# 1. Generate speech to file
/home/globalcaos/.openclaw/tools/sherpa-onnx-tts/bin/sherpa-onnx-offline-tts \
  --vits-model=/home/globalcaos/.openclaw/tools/sherpa-onnx-tts/models/vits-piper-en_GB-alan-medium/en_GB-alan-medium.onnx \
  --vits-tokens=/home/globalcaos/.openclaw/tools/sherpa-onnx-tts/models/vits-piper-en_GB-alan-medium/tokens.txt \
  --vits-data-dir=/home/globalcaos/.openclaw/tools/sherpa-onnx-tts/models/vits-piper-en_GB-alan-medium/espeak-ng-data \
  --vits-length-scale=0.5 \
  --output-filename="$RAW_WAV" \
  "$@" >/dev/null 2>&1

# 2. Apply metallic effects - BRIGHT + 5% PITCH UP
# NOTE: sherpa-onnx outputs 22050Hz
# - asetrate/aresample: pitch up 5%
# - aecho: 0.25/0.2 decay
# - chorus for slight detuning/thickness  
# - highpass at 300Hz, lowpass at 8000Hz
# - treble boost +6dB at 3kHz
# - high shelf boost at 5kHz
if [ -f "$RAW_WAV" ]; then
  ffmpeg -y -i "$RAW_WAV" \
    -af "asetrate=22050*1.05,aresample=22050,\
aecho=0.4:0.4:8|12:0.25|0.2,\
chorus=0.5:0.9:50|60:0.4|0.32:0.25|0.4:2|1.3,\
highpass=f=300,lowpass=f=8000,\
treble=g=6:f=3000,\
equalizer=f=5000:t=h:w=2000:g=4" \
    "$METAL_WAV" -v error

  # 3. Play
  if [ -f "$METAL_WAV" ]; then
    aplay -D plughw:0,0 -q "$METAL_WAV"
    rm "$RAW_WAV" "$METAL_WAV"
  fi
fi
