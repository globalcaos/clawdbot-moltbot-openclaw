# 2026-02-08

## ğŸ”´ CRITICAL INCIDENT: Merge Disaster

**What happened:** I attempted to merge upstream without first checking if a prior merge was already incomplete. The repo had 26 files with unresolved conflict markers (including `package.json`), making the entire system non-functional.

**Root cause:** I assumed a fresh `git merge` without verifying the working tree was clean.

**Impact:** 26 files overwritten with upstream versions, losing local customizations.

**Recovery:**

- Backups preserved at `~/src/openclaw-backup-conflicted-files/`
- Restored budget tracking in `usage.ts` (token-usage-tracker wiring)
- Created Manus plugin to isolate Manus-specific code

**Lesson:** **ALWAYS run `git status` and check for conflict markers before ANY merge operation.**

```bash
# Pre-merge checklist
git status                           # Check for uncommitted changes
grep -r "<<<<<<< HEAD" . --include="*.ts" --include="*.json"  # Check for lingering conflicts
```

---

## âœ… Fork Sync Complete

**Branch:** `main` at `eb07a27ee`
**Upstream commits merged:** 519+
**Files changed:** 1563

### New Features from Upstream

- Telegram spoilers (#11543)
- Context overflow fix (#11664)
- Voyage AI embeddings (new memory backend)
- Feishu integration (full plugin)
- Usage dashboard (new UI views)
- Chinese docs (full zh-CN translation)

### Our Additions

- Manus plugin (`extensions/manus/`)
- Budget tracking restoration
- better-sqlite3 dependency (WhatsApp history)

### Skills Cleaned

- Removed `chatgpt-export` (superseded by chatgpt-exporter-ultimate on ClawHub)
- Removed `youtube` (superseded by youtube-ultimate on ClawHub)
- Created `token-control-panel-ultimate` (beta, in workspace, not published)

---

## ğŸ”§ Clean Fork Strategy Established

**Problem:** Every merge conflicts because we mix core modifications, skills, and personal config.

**Solution:**
| What | Where | Why |
|------|-------|-----|
| **Skills** | ClawHub | Independent versioning, no merge conflicts |
| **Personal config** | `~/.openclaw/workspace/` | Never in repo |
| **Useful features** | **PR to upstream** | If accepted, we don't maintain it |
| **Local-only hacks** | Plugins | Plugin system isolates them |

---

## ğŸ“¦ Manus Plugin Created

**Location:** `extensions/manus/`
**Purpose:** Standalone credit tracking for Manus AI integration

**Files:**

- `index.ts` - Plugin registration, gateway methods
- `src/tracker.ts` - Credit tracking logic
- `manus-watch.py` - Polling + auto-notification script
- `README.md` - Documentation

**Gateway methods registered:**

- `usage.manus.track` - Record task completion
- `usage.manus.summary` - Get usage summary
- `usage.manus.budget` - Get budget context

**Benefit:** No more modifying core `usage.ts` - plugin handles all Manus-specific code.

---

## âœ… UI Thinking Indicator Bug FIXED

**Symptom:** Thinking indicator stuck/always showing in webchat
**Root cause:** Missing `runId` in `app-render.ts` ThinkingIndicator props
**Fix:** Added `runId: state.chatRunId` to ThinkingIndicator in `ui/src/ui/app-render.ts`

---

## ğŸ” AI Budget Tracking Research

**Claude/Anthropic:**

- Usage and Cost API available
- CostTracker class in codebase
- Datadog/Grafana dashboards for enterprise
- `/cost` command for per-session tracking

**Manus:**

- Credit-based (~$0.01/credit)
- Settings > Usage page in web UI
- ~150 credits/task typical
- `manus-watch.py` for polling + auto-notification

**Gemini:**

- Cloud Billing API
- Firebase Usage/Billing dashboard
- Vantage for unified visualization
- Budget alerts configurable at 50%/80%/100%

**Next:** Unified token-control-panel-ultimate to aggregate all platforms

---

## ğŸ”„ Fork Upstream Sync (In Progress)

**Status:** Pulling 3 remaining upstream commits (pid 1305759)
**Branch:** main at `01e87b2a3` â†’ syncing to latest upstream

---

## ğŸ›ï¸ Budget Panel Widget Created

**Location:** `~/.openclaw/workspace/scripts/budget-panel-widget.user.js`
**Type:** Tampermonkey userscript (no core UI modifications!)

**Features:**

- Floating panel, bottom-left of webchat
- Draggable, collapsible
- Shows Claude, Manus, Gemini usage
- Auto-refreshes every 30s
- Color-coded bars (ğŸŸ¢â†’ğŸ”´)

**Tampermonkey Setup Note:**

- Must enable **"Allow User Scripts"** in Tampermonkey settings
- Script uses `@run-at document-idle` + delayed init for timing

**Backend:**

- Plugin at `~/.openclaw/extensions/budget-panel/`
- Gateway method: `budget.status`
- Currently shows 0% (needs wiring to actual usage APIs)

---

## ğŸ’ Claude Max Plan Upgrade

**Date:** 2026-02-08
**Change:** Pro â†’ Max (20x more usage)
**Impact:** Can return to thorough, detailed responses. No more extreme conciseness mode.

---

## ğŸ› Manus Plugin Missing Manifest

**What happened:** I created `extensions/manus/` but forgot `openclaw.plugin.json`. This caused gateway to crash on every startup with config validation error.

**Fix:** Claude console created the missing manifest file.

**Lesson:** Every OpenClaw plugin MUST have:

```
extensions/<name>/
â”œâ”€â”€ index.ts
â”œâ”€â”€ package.json
â””â”€â”€ openclaw.plugin.json  â† REQUIRED!
```

**Plugin manifest template:**

```json
{
  "id": "manus",
  "name": "Manus AI Integration",
  "description": "Credit tracking for Manus AI async tasks",
  "configSchema": {}
}
```

---

## ğŸ› Budget-Panel Plugin Broke Gateway (AGAIN â€” Same Pattern!)

**What happened:** The `budget-panel` plugin was disabled by:

1. Renaming directory to `extensions/_disabled_budget-panel/`
2. Renaming `openclaw.plugin.json` â†’ `openclaw.plugin.json.disabled`
3. Config still had `"budget-panel": { "enabled": true }`

**Result:** Gateway crash-loop. `openclaw doctor --fix` could not auto-repair. Oscar had to fix it externally via Claude Code.

**Fix applied:**

1. Set `"enabled": false` in `~/.openclaw/openclaw.json`
2. Renamed `openclaw.plugin.json.disabled` back to `openclaw.plugin.json`

**This is the SECOND manifest-related crash today** (first was Manus missing manifest).

**RULE â€” Correct way to disable a plugin:**

1. Set `enabled: false` in `openclaw.json` â€” this is the ONLY switch
2. NEVER rename or delete `openclaw.plugin.json` â€” validator needs it regardless of enabled state
3. Directory prefix `_disabled_` is cosmetic only â€” it does NOT disable anything
4. Always verify: `openclaw doctor` must show zero config errors after any plugin change

**See:** `lessons/2026-02-08-plugin-disable-procedure.md`

---

## ğŸ“ Skills Status

**On ClawHub (published):**

- youtube-ultimate v1.0.2
- whatsapp-ultimate v1.1.1
- agent-boundaries-ultimate v1.2.1
- agent-memory-ultimate v2.0.1
- shell-security-ultimate v1.0.0
- chatgpt-exporter-ultimate

**In workspace (not published):**

- token-control-panel-ultimate v0.1.0 (beta)

**In fork (to keep):**

- exec-display (source for token-control-panel)
- google-sheets (our creation)
- whatsapp-tools (unique contact sync scripts)

---

## ğŸ’¡ Claude Max Billing Clarification

**Critical discovery:** The $788 shown in budget tracking is **fake internal accounting**, NOT a real bill.

**How it works:**

- Oscar pays **$100/month flat** for Claude Max subscription
- OpenClaw tracks "equivalent API cost" internally for usage patterns
- This is informational only â€” no actual per-token charges

**Implication for budget panel:**

- Subscription mode should show "Flat $100/mo" not dollar amounts
- Usage tracking is for pattern analysis, not cost control
- `claude-usage.json` now has `"mode": "subscription"` marker

**Detection logic needed:**

```typescript
if (data.mode === "subscription") {
  // Show "Flat" instead of dollar amounts
  // Still track tokens for pattern analysis
}
```

---

## ğŸ› Budget Panel Subscription Detection Bug

**Status:** In progress
**Symptom:** Claude shows $0.00/$200.00 defaults despite file being read
**Root cause:** `loadClaudeUsage()` returns correct data but display logic not updated

**Files involved:**

- `~/.openclaw/extensions/budget-panel/src/tracker.ts`
- `~/.openclaw/workspace/memory/claude-usage.json`
- `~/.openclaw/workspace/scripts/budget-panel-widget.user.js`

**Next:** Verify gateway restart reloads tracker changes, then fix display logic

---

## ğŸ”¬ Rate Limit Deep Dive

**Claude Max (API-style limits per 5h window):**

- ~900 messages OR ~200-800 prompts depending on complexity
- Weekly Sonnet/Opus allocation (hours, not tokens)
- Headers: `anthropic-ratelimit-{requests,tokens}-remaining`, `*-reset` (ISO timestamp)

**Gemini (per-model RPM/TPM/RPD):**

- RPM/TPM reset every 60 seconds
- RPD resets at midnight Pacific (08:00 CET)
- Headers: `X-RateLimit-Remaining`, `X-RateLimit-Reset` (Unix), `Retry-After`

**Models with UNLIMITED RPD (critical for fallback safety):**

- gemini-2.5-flash
- gemini-2.0-flash
- gemini-2.0-flash-lite
- gemini-embedding-1

**Manus Pro:**

- 11,234 total credits (3938/4000 monthly + 7296 addon)
- Daily refresh: 300 at 01:00

---

## ğŸ¯ Gemini Fallback Chain (by Performance)

**Configured order (most capable â†’ unlimited safety nets):**

```
gemini-3-pro â†’ gemini-2.5-pro â†’ gemini-2.5-flash(âˆ) â†’ gemini-3-flash â†’ gemini-2.0-flash(âˆ) â†’ gemini-2.0-flash-lite(âˆ)
```

**Philosophy:** Maximize capability, use unlimited RPD models as safety nets between premium tiers.

---

## ğŸ›ï¸ Budget Panel v2.0.0

**Location:** `~/.openclaw/workspace/scripts/budget-panel-widget.user.js`

**Multi-provider display:**

- Claude Max (subscription mode, shows 5h window usage)
- 6 Gemini models (3-pro, 2.5-pro, 2.5-flash, 3-flash, 2.0-flash, 2.0-flash-lite)
- Manus Pro credits

**Usage data files:**

- `~/.openclaw/workspace/memory/claude-usage.json`
- `~/.openclaw/workspace/memory/gemini-usage.json`
- `~/.openclaw/workspace/memory/manus-usage.json`

**Status:** Oscar pasting into Tampermonkey (opened via `nohup gedit`)

---

## ğŸ”§ ResourceMonitor Modification Planned

**Goal:** Shrink to 75% width, show cascading model display

**Logic:**

- Show only ACTIVE Gemini model (current)
- When model exhausted â†’ cascade: "used up" models + current + "next" models
- Visual: strikethrough for exhausted, highlight for active

**Status:** Design phase, implementation pending

---

## ğŸ‰ CLAUDE MAX USAGE API CRACKED

**Discovery:** Claude Code stores OAuth tokens at `~/.claude/.credentials.json`

**API Endpoint:**

```
GET https://api.anthropic.com/api/oauth/usage
Authorization: Bearer sk-ant-oat01-...
anthropic-beta: oauth-2025-04-20
```

**Response:**

```json
{
  "five_hour": { "utilization": 13.0, "resets_at": "..." },
  "seven_day": { "utilization": 50.0, "resets_at": "..." },
  "seven_day_sonnet": { "utilization": 0.0, "resets_at": "..." }
}
```

**Files created:**

- `scripts/claude-usage-fetch.py` â€” Fetches real usage from OAuth API
- `memory/claude-usage.json` â€” Stores usage data for Budget Panel
- Cron job: `*/5 * * * *` â€” Auto-updates every 5 minutes

**Budget Panel v3.0.0:**

- Updated Tampermonkey script to display real Claude usage
- Plugin moved to main `extensions/` folder
- Gateway method `budget.usage` reads JSON files

**No extensions. No Mac. Pure Linux hacking.**

---

## ğŸ“¦ token-control-panel-ultimate v0.2.0

Packaged the discoveries as a skill:

**Location:** `skills/token-control-panel-ultimate/`

**Contents:**

- Claude OAuth API discovery + usage fetcher
- Gemini multi-model bottleneck tracking
- Manus credit monitoring
- Command security levels
- Budget-aware behavior guidelines
- Webchat widget (Tampermonkey)

**Ready for ClawHub publish** (after testing)
