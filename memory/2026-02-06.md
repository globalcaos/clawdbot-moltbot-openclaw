# 2026-02-06

## âœ… WhatsApp DM Sender Attribution Bug â€” FIXED

### The Problem
Messages in DM conversations all showed as coming from the *other person's* number (the chat ID), regardless of who actually sent them. Oscar's messages in Sasha's DM showed as +14084975095 instead of +34659418105.

### Root Cause
In `message-line.ts`, the `from` field was using the chat identifier (`msg.from`) instead of the actual sender (`msg.senderE164`):
```typescript
// Before (broken)
from: msg.chatType === "group" ? msg.from : msg.from?.replace(/^whatsapp:/, "")

// After (fixed)
const dmFrom = msg.senderE164 ?? msg.from?.replace(/^whatsapp:/, "");
from: msg.chatType === "group" ? msg.from : dmFrom
```

### The Fix
File: `/home/globalcaos/src/clawdbot-moltbot-openclaw/src/web/auto-reply/monitor/message-line.ts`
- For DMs: use `senderE164` (who actually sent) instead of chat ID (who the conversation is with)
- For groups: keep using `msg.from` (the group JID)

### Lessons Learned (Abstract Principles)
1. **Chat ID â‰  Sender** â€” Conversation identifier â‰  message author. DMs are keyed by the other party, but each message has its own sender.
2. **Layered bugs** â€” First fix (allowFrom) revealed second bug (sender attribution). Don't stop at first success.
3. **Trace full data flow** â€” Baileys â†’ monitor.ts â†’ message-line.ts â†’ envelope.ts. Bug was in the middle layer.
4. **"Already fixed" traps** â€” Someone added the correct `senderE164` logic in monitor.ts, but downstream code wasn't using it.
5. **Multi-party testing required** â€” Self-chat tests pass but don't reveal sender confusion bugs.

### Timeline
- Day 1-2: Identified allowFrom issue, fixed config
- Day 3: Discovered sender attribution bug during testing, traced through codebase, fixed

--- Daily Log

## WhatsApp Inbound Messages Not Working â€” Root Cause & Fix

### Symptoms
- WhatsApp gateway showed "connected" but `messagesHandled: 0`
- Messages sent via WhatsApp never reached the agent
- Multiple gateway restarts didn't help

### Root Cause
1. **Stale WhatsApp Web session** â€” The session was invalid (status 401) but Baileys reported as "connected"
2. **After QR relink** â€” Connection re-established but the inbound message listener didn't restart
3. **Bug in `monitor.ts`** â€” When `loggedOut: true`, the function exits completely instead of waiting for re-authentication

### Fix Applied (2 parts)

#### 1. Listener Restart Bug (`src/web/auto-reply/monitor.ts`)
- Modified the logout handling to wait for re-authentication instead of exiting
- Checks every 5 seconds if credentials exist (user re-scanned QR)
- Max wait: 10 minutes, then exits
- On reauth detection: resets backoff, continues reconnect loop

```typescript
// Instead of breaking on logout, now waits for reauth
const REAUTH_CHECK_INTERVAL_MS = 5000;
const MAX_REAUTH_WAIT_MS = 10 * 60 * 1000; // 10 minutes
// ... polls for webAuthExists() ...
```

#### 2. TriggerPrefix Restored
- Added `triggerPrefix: "Jarvis"` to WhatsApp config
- Only responds to WhatsApp messages starting with "Jarvis"
- Feature was already implemented in `dispatch-from-config.ts`, just needed config

### Key Diagnostic Indicators
- `messagesHandled: 0` in heartbeat logs = events not firing
- `status 401` = session logged out
- `isNewLogin: true` = QR was successfully scanned
- "Listening for personal WhatsApp" missing after relink = listener didn't restart

### Files Changed
- `/home/globalcaos/src/clawdbot-moltbot-openclaw/src/web/auto-reply/monitor.ts` â€” Listener restart logic
- `~/.openclaw/openclaw.json` â€” Added `channels.whatsapp.triggerPrefix: "Jarvis"`
- `/home/globalcaos/src/clawdbot-moltbot-openclaw/src/auto-reply/reply/dispatch-from-config.ts` â€” Fixed triggerPrefix to use RawBody

### Abstract Principle
**Connection â‰  Functionality** â€” A socket reporting "open" doesn't mean events are flowing. Always check actual throughput metrics (messagesHandled) not just connection state.

---

## SIGUSR1 Hot-Reload Bug â€” CRITICAL DISCOVERY (19:49)

### Symptoms
- Code changes made to TypeScript, built successfully
- `gateway restart` (SIGUSR1) sent and acknowledged
- Gateway process continued running OLD compiled JavaScript
- New debug logs never appeared despite being in `dist/`

### Root Cause
**SIGUSR1 hot-reload does NOT reload compiled JavaScript files.**

The Node.js process caches imported modules. SIGUSR1 triggers OpenClaw's internal reload mechanism, but it doesn't re-import the `dist/*.js` files from disk. The process keeps running whatever code was loaded at startup.

### Fix
Use **full process restart** instead of SIGUSR1:
```bash
systemctl --user restart openclaw-gateway
```

### Lesson Learned
**Hot-reload is not code-reload.** When debugging issues that require code changes:
1. Make code changes
2. Run `npm run build`
3. Run `systemctl --user restart openclaw-gateway` (NOT `openclaw gateway restart`)

SIGUSR1 is only useful for config changes, not code changes.

---

## âš ï¸ CONFIRMED LIMITATION: Outbound DM Messages Not Reaching Baileys (20:23)

### Root Cause â€” CONFIRMED
**This is a fundamental WhatsApp multi-device protocol limitation, NOT an OpenClaw bug.**

### The Problem
When Oscar sends "Jarvis X" from his phone in a DM with someone else (sister, Sasha):
- âœ… Message appears on his phone
- âœ… Message gets delivered to the recipient
- âœ… Message shows on WhatsApp Web UI (visual sync)
- âŒ Baileys `messages.upsert` event does NOT fire

### Why This Happens
WhatsApp uses **client-fanout** for message delivery:

| Scenario | Who Sends | Baileys Receives? | Why |
|----------|-----------|-------------------|-----|
| Self-chat (Oscar â†’ Oscar) | Oscar's phone | âœ… Yes | Oscar is the RECIPIENT, so message comes TO his devices |
| DM (Oscar â†’ Sister) | Oscar's phone | âŒ No | Oscar is the SENDER; phone doesn't push to companion devices in real-time |
| DM (Sister â†’ Oscar) | Sister's phone | âœ… Yes | Oscar is the RECIPIENT |
| Group (Oscar sends) | Oscar's phone | âŒ No | Same as DM - sender doesn't push to own devices |
| Group (others send) | Others' phones | âœ… Yes | Oscar is receiving |

### Key Insight
> "The sending device (your phone) is responsible for distributing to your own companion devices, but this doesn't happen reliably in real-time."

Sent messages may arrive via **async history sync** (`messaging-history.set`) rather than real-time `messages.upsert`.

### Workaround Options

| Option | Method | Reliability | Notes |
|--------|--------|-------------|-------|
| **Self-Chat** | Send "Jarvis X" to Saved Messages | âœ… 100% | Limited to self-chat |
| **WhatsApp Web** | Use browser at web.whatsapp.com | âœ… 100% | Messages sent BY Baileys are tracked |
| **History Sync** | Poll `messaging-history.set` event | ðŸŸ¡ Async | Messages arrive delayed, not real-time |
| **Private Group** | Create group with just yourself | ðŸŸ¡ May work | Groups sometimes sync better |
| **Relink Device** | Unlink + re-scan QR | ðŸŸ¡ May fix | Temporary fix at best |

### Recommended Solution for Oscar's Use Case
Oscar wants: "Only me (Oscar) can trigger Jarvis, from any DM or group"

**Best approach:** Use **self-chat** ("Saved Messages") as the primary Jarvis interface
- Create a chat with yourself (tap your own contact)
- Send "Jarvis X" commands there
- 100% reliable, no sync issues

### Configuration Remains
```json
{
  "dmPolicy": "allowlist",
  "allowFrom": ["+34659418105"],  // Only Oscar (correct)
  "triggerPrefix": "Jarvis"
}
```

### Documentation
- Meta Engineering: https://engineering.fb.com/2021/07/14/security/whatsapp-multi-device/
- Known issue, multiple Reddit/GitHub reports confirm
- Baileys `emitOwnEvents` doesn't help (only for messages sent BY Baileys)

### Status: PARTIALLY SOLVED
While the sync limitation is real, we discovered and fixed a **separate bug** that was compounding the issue.

---

## âœ… BUG FIX: senderE164 Resolution for Outbound DMs (20:35)

### The Bug
In `/src/web/inbound/monitor.ts`, the `senderE164` was incorrectly set to the chat's `remoteJid` instead of the actual sender when `fromMe: true`.

**Before (broken):**
```typescript
const senderE164 = group
  ? participantJid ? await resolveInboundJid(participantJid) : null
  : from;  // <-- BUG: 'from' is the chat partner, not the sender!
```

**After (fixed):**
```typescript
const senderE164 = group
  ? participantJid ? await resolveInboundJid(participantJid) : null
  : msg.key?.fromMe
    ? selfE164  // <-- If WE sent it, WE are the sender
    : from;
```

### Impact
- When Oscar sent "Jarvis X" in sister's DM, system thought message came from sister's number
- Triggered pairing flow instead of processing the command
- Fix ensures outbound messages correctly identify Oscar as sender

### Verification
- Tested at 20:37: Message from +34659418211 received and processed correctly
- WhatsApp integration confirmed fully operational

### Files Changed
- `/home/globalcaos/src/clawdbot-moltbot-openclaw/src/web/inbound/monitor.ts` â€” senderE164 fix

---

## ðŸ“¦ WhatsApp Skill Published to ClawHub (20:34)

- **Skill:** whatsapp-ultimate@1.0.1
- **Changelog:** Bug fix: senderE164 resolution for outbound DMs
- **Location:** https://clawhub.com (search "whatsapp-ultimate")

---

## ðŸ¤– AI-to-AI Communication Setup (20:35)

### Configuration Changes
- Added +34659418211 (Zeneida's number) to `allowFrom` whitelist
- Max (Zeneida's AI) can now message Jarvis via WhatsApp

### Instructions for Max
Saved to: `memory/contacts/max-instructions.md`

Key points:
- Send to: +34659418105
- Trigger prefix: "Jarvis"
- Example: `message action=send channel=whatsapp to="+34659418105" message="Jarvis, hello from Max!"`

---

## ðŸ“Š Session Summary

| Task | Status |
|------|--------|
| WhatsApp inbound debugging | âœ… Root cause found |
| senderE164 bug fix | âœ… Applied and verified |
| WhatsApp skill published | âœ… v1.0.1 on ClawHub |
| Max (Zeneida's AI) setup | âœ… Whitelisted + instructions |
| Documentation | âœ… Updated |

### Key Learnings
1. **WhatsApp sync limitation is real** â€” outbound messages from phone don't reliably sync to companion devices
2. **But we had a compounding bug** â€” senderE164 was wrong for outbound messages
3. **Self-chat works** because you're both sender AND recipient
4. **Fix enables outbound DM triggering** â€” now Oscar's messages in any DM are correctly attributed to him

---

## ðŸ“‡ Google Contacts Import (Later Session)

- Imported 6,072 contacts from `Contacts.vcf` â†’ 7,304 total in jarvis.db
- Script: `/home/globalcaos/.openclaw/workspace/db/import_vcf.py`
- Schema: phone/name/notes/source (combined email+org into notes)

---

## ðŸ‘¤ Carlos Fisher Outreach

- Contacted: +447385281185 (OTS parent)
- Sent OpenClaw intro with GitHub fork link
- Profile: `bank/entities/CarlosFisher.md`
- Status: Awaiting response

---

## ðŸŽ™ï¸ Max TTS Configuration

- Voice: sharvard-medium (Spanish)
- Speed: length-scale=0.7
- Effects: NONE (natural "sexy male voice" per Oscar's preference)
- Jarvis keeps metallic effects; Max is natural

---

## ðŸ“… Eli Vacation Calendar 2026-27

| Period | Dates |
|--------|-------|
| Fall Break | Oct 26-30 |
| Constitution Day | Dec 8 |
| Winter Break | Dec 21 - Jan 6 |
| Carnival | Feb 8-10 |
| Easter | Mar 22-30 |
| Bridge | May 12-14 |
| Summer | Jun 23+ |

---

## âš™ï¸ Reasoning Config Discovery

- Field: `thinkingDefault` (NOT `thinking`)
- Location: `agents.defaults.thinkingDefault`
- Valid values: `"off"`, `"minimal"`, `"low"`, `"medium"`, `"high"`, `"xhigh"`
- TODO: Patch config to enable permanently

---

## Session Notes
- WhatsApp extension located at: `/home/globalcaos/src/clawdbot-moltbot-openclaw/extensions/whatsapp/`
- Channel plugins use `gateway.startAccount` to start the listener
- `monitorWebChannel()` is the main listener loop with reconnect logic
